<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <title>罐子实验</title>
    <style>
        body {
            font-family: "Times New Roman", "楷体", serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .reward-info {
            position: absolute;
            top: 12%;
            right: 20%;
            padding: 5px 10px;
            background-color: white;
            border: 0.1px solid #000;
            border-radius: 5px;
            width: 100px;
            font-size: 1.2em;
            text-align: center;
        }
        .reward-info div {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px 0;
        }
        .reward-info div span {
            margin-left: 5px;
        }
        .container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            padding: 10px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 80%;
        }
        .jar-contain {
            text-align: center;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        .jar {
            border-radius: 10px;
            padding: 20px;
            width: 150px;
            height: 150px;
            text-align: center;
            background-image: url('罐子.png');
            background-size: cover;
            background-position: center;
        }
       
        .ball-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-top: 95px;
        }
        .ball {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: grey;
            margin: 3px auto;
        }
        .red { background-color: red; }
        .blue { background-color: blue; }
        .round {
            margin-top: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: #555;
        }
        .slider-container {
            width: 60%;
            margin-top: 0px;
            padding: 20px;
            display: none;
        }
        .slider-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            margin-left: -100px;
        }
        .slider-label {
            font-size: 1.1em;
            margin-right: -289px; 
            width: 500px;
            text-align: left;
        }
        .slider-input {
            flex: 1;
            margin-right: 10px;
            height: 8px;
        }
        .slider-value {
            width: 50px;
            padding: 5px;
            border: 1px solid #000;
            border-radius: 5px;
            text-align: center;
            font-size: 1.2em;
        }
        .slider-ticks {
            display: flex;
            justify-content: space-between;
            margin-top: -20px;
            font-size: 0.9em;
            color: #555;
            padding-left: 45px;
            padding-right: 5px;
        }
        .slider-ticks span {
            width: 200px;
            text-align: center;
        }
        button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 1.5em;
            cursor: pointer;
            background-color: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 5px;
            box-shadow: 0 4px #999;
        }
        .blank-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #555;
            z-index: 1000;
        }
        #roundInfo {
            font-size: 1.0em;
            line-height: 1.5;
            color: #333;
            margin: 20px 0;
            text-align: center;
        }
        .reward-result {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border: 1px solid #000;
            border-radius: 10px;
            z-index: 2000;
            max-width: 90%;
            width: 800px;
            text-align: center;
            display: none;
        }
        .jars-display {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin: 30px 0;
        }
        @media (max-width: 600px) {
            .container {
                flex-direction: column;
            }
            .jar-contain {
                width: 100%;
                margin: 10px 0;
            }
            .reward-info {
                width: 95%;
            }
        }
        /* 结果展示样式 */
        .phase-container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .phase-title {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .comparison-jars {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin: 20px 0;
        }
        .jar-group {
            text-align: center;
        }
        .jar-group h3 {
            margin: 10px 0;
            color: #34495e;
        }
        .highlight {
            color: #000;
            font-weight: bold;
        }
        /* 滚动容器样式 */
        .reward-result {
            max-height: 80vh; /* 限制容器高度 */
            overflow-y: auto; /* 启用垂直滚动 */
            padding: 20px;
            margin: 20px;
        }

        /* 之前的样式保持不变 */
        .quiz-container {
            display: none; /* 初始隐藏问卷 */
            position: fixed;
            top: 0;
            left: 0;
            width: 97%;
            height: 90%;
            background: white;
            z-index: 9999;
            text-align: center;
            padding: 20px;
            overflow-y: auto;
            
        }
        .quiz-container h3 {
            margin-bottom: 20px;
        }
        .quiz-container form {
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
            font-size: 1.5em;
        }
        .quiz-container p {
            margin: 15px 0;
        }
        .quiz-container input[type="radio"] {
            margin-right: 10px;
        }
        .quiz-container button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
        }
       /* 基础容器样式 */
        div[class^="page"] {
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

/* 信息强调块 */
.info-block {
    background: #f8f9fa;
    border-left: 4px solid #395ca2;
    padding: 15px;
    margin: 15px 0;
}

/* 响应式布局 */
@media (max-width: 768px) {
    .grid-container {
        grid-template-columns: 1fr;
    }
}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <!-- 实验指导语 -->
    

    <div id="instruction" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; text-align: center; padding: 20px; overflow-y: auto;"> 
        <div id="page1">
            <h2>Experiment Instructions</h2>
            <div style="max-width:800px; margin:20px auto; text-align:left">
                <p style="font-size:1.2em; line-height:1.6">
                    Welcome to the experiment! Please read the following instructions carefully. You will answer some related questions afterward. If you answer correctly, you will proceed to the formal experiment. If you answer incorrectly, you will need to read the instructions again.
                </p>
            </div>
            <button onclick="showPage(2)">I Agree</button>
        </div>
        <div id="page2" style="display:none">
            <div style="max-width:800px; margin:20px auto; text-align:left">
                <p style="font-size:1.2em; line-height:1.6">
                    As shown in the figure below, you will see two jars, each containing 10 balls. The colors of these balls are either <span style='color:red'>red</span> or <span style='color:blue'>blue</span>. However, <span style='color:#395ca2'><strong>some balls in both jars are displayed in gray, indicating that the color of the balls is unknown</strong>.
                    <img src="intro_jar.png" style="width:55%;
                                                    border:1px solid #ddd;
                                                    display: block;  
                                                    margin: 0 auto;
                                                    margin-top: 20px"> 
                </p>
            </div>
            <button onclick="showPage(3)">Next Page ▶</button>
        </div>
        <div id="page3" style="display:none">
            <div style="max-width:800px; margin:20px auto; text-align:left">
                <p style="font-size:1.2em; line-height:1.6"> 
                    You will choose one jar to play a simulated ball-drawing game, and the system will draw one ball from the 10 balls in the selected jar. The color of the drawn ball will determine your final reward. Faced with two jars with different information, you need to choose one based on your personal preference for the ball-drawing game.
                    <span style='color:#395ca2'><strong>The base reward for the experiment is 5 dollars. If you draw a red ball, you will receive an additional 2 dollars, totaling 7 dollars; if you draw a blue ball, you will lose 2 dollars, totaling 3 dollars.</strong></span>
                </p>
                <img src="intro_reward.png" style="width:75%;
                                                    border:1px solid #ddd;
                                                    display: block;  
                                                    margin: 0 auto;
                                                    margin-top: 20px"> 
            </div>
            <button onclick="showPage(2)">◀ Previous Page</button>
            <button onclick="showPage(4)" style="margin-left:20px">Next Page ▶</button>
        </div>
        
        <div id="page4" style="display:none">
            <div style="max-width:800px; margin:20px auto; text-align:left">
                <p style="font-size:1.2em; line-height:1.6"> 
                    To understand the strength of your preferences, please allocate 100 willingness points. Specifically, <span style='color:#395ca2'><strong>the more willingness points allocated to a jar, the more you prefer to choose that jar for the ball-drawing game.</strong></span> For example:<br>
                    <li style="font-size:1.2em; line-height:1.6">If you allocate 0 willingness points to Jar A and 100 willingness points to Jar B, it indicates that you completely prefer Jar B for the ball-drawing game, without considering Jar A.<br>
                    <li style="font-size:1.2em; line-height:1.6">If you allocate 50 willingness points to both Jar A and Jar B, it indicates that you have the same preference for both jars.<br>
                    <li style="font-size:1.2em; line-height:1.6">If you allocate 80 willingness points to Jar A and 20 willingness points to Jar B, it indicates that you prefer to choose Jar A.
                </p>
            </div>
            <button onclick="showPage(3)">◀ Previous Page</button>
            <button onclick="showPage(5)" style="margin-left:20px">Next Page ▶</button>
        </div>
        
        <div id="page5" style="display:none">
            <div style="max-width:800px; margin:20px auto; text-align:left">
            <p style="font-size:1.2em; line-height:1.6"> 
                As shown in the figure below, during the experiment, you will need to drag a slider to allocate willingness points. While dragging the slider, you will see the specific willingness points allocated to Jar A and Jar B. After you finish allocating willingness points, please click "Confirm Allocation".
                <img src='intro_slider.png' style='width: 100%;margin-left:0%;margin-right:10%;margin-top:3%;margin-bottom:2%;border-style: ridge;'>
                After confirmation, you will see <span style='color:#395ca2'><strong>a new pair of jars</strong></span>, with the same game rules. Please continue to allocate willingness points.
                In this experiment, you will need to allocate willingness points to <span style='color:#395ca2'><strong>93 pairs of jars</strong></span> according to the above rules.
            </p>
                </div>
            <button onclick="showPage(4)">◀ Previous Page</button>
            <button onclick="showPage(6)" style="margin-left:20px">Next Page ▶</button>
        </div>
    
        <div id="page6" style="display:none">
            <div style="max-width:800px; margin:20px auto; text-align:left">
                <p style="font-size:1.2em; line-height:1.6"> 
                    Please note that the results of your willingness point allocation will be recorded each time. After the experiment is completed, the system will <span style='color:#395ca2'><strong>randomly select one record</strong></span> from all your willingness point allocations (a total of 93 records) and use your willingness point allocation to choose the corresponding jar for the simulated ball-drawing game, <span style='color:#395ca2'><strong>which will determine the additional reward you can receive</strong></span>.<br><br>
                    For example: If you allocate 25 willingness points to Jar A and 75 willingness points to Jar B, the system will first decide which jar to draw from, with a 25% probability of choosing Jar A and a 75% probability of choosing Jar B.
                    <span style='color:#395ca2'><strong>Your final reward is related to your willingness point allocation results, so please make your decision carefully.</strong></span><br><br>
                    If you understand the game, please click the "Start Answering" button to answer the questions.
                </p>
            </div>
            <button onclick="showPage(5)">◀ Previous Page</button>
            <button onclick="showQuiz()" style="margin-left:20px">Start Answering</button>
        </div>
    </div>
    


    <!-- 问卷页面 -->
    <div id="quiz" class="quiz-container">
        <h3>Test</h3>
        <form id="quizForm">
           <!-- 问题1 -->
<p>1. In the simulation game, how many jars will you see simultaneously?</p>
<input type="radio" name="q1" value="1"> 1<br>
<input type="radio" name="q1" value="2"> 2<br>
<input type="radio" name="q1" value="3"> 3<br>
<input type="radio" name="q1" value="4"> 4<br>

<!-- 问题2 -->
<p>2. Which three colors might the balls in the jars have?</p>
<input type="radio" name="q2" value="1"> Red, yellow, green<br>
<input type="radio" name="q2" value="2"> Yellow, green, white<br>
<input type="radio" name="q2" value="3"> Blue, gray, yellow<br>
<input type="radio" name="q2" value="4"> Red, blue, gray<br>

<!-- 问题3 -->
<p>3. Drawing a red ball will yield an additional ____, and drawing a blue ball will result in an additional ____.</p>
<input type="radio" name="q3" value="1"> Gain, Loss<br>
<input type="radio" name="q3" value="2"> Loss, Gain<br>
<input type="radio" name="q3" value="3"> Gain, Gain<br>
<input type="radio" name="q3" value="4"> Loss, Loss<br>

<!-- 问题4 -->
<p>4. When allocating willingness points, which of the following statements is correct?</p>
<input type="radio" name="q4" value="1"> The colors of all the balls in both jars are unknown.<br>
<input type="radio" name="q4" value="2"> The colors of all the balls in one jar are known.<br>
<input type="radio" name="q4" value="3"> The colors of some balls in both jars are unknown.<br>
<input type="radio" name="q4" value="4"> The colors of all the balls in both jars are known.<br>

<!-- 问题5 -->
<p>5. Jack allocated 90 willingness points to Jar A and 10 willingness points to Jar B in a trial. What does this indicate?</p>
<input type="radio" name="q5" value="1"> Jack has a strong preference for Jar A.<br>
<input type="radio" name="q5" value="2"> Jack has a slight preference for Jar A.<br>
<input type="radio" name="q5" value="3"> Jack has a slight preference for Jar B.<br>
<input type="radio" name="q5" value="4"> Jack has a strong preference for Jar B.<br>

<!-- 问题6 -->
<p>6. As shown in the figure, if the additional reward is settled based on this record, what is the probability of settling from Jar A? And given that a ball is drawn from Jar A, what is the probability of getting +2$?</p>
<img src='question.png' style='width: 100%;margin-left:0%;margin-right:10%;margin-top:3%;margin-bottom:2%;border-style: ridge;'>
<input type="radio" name="q6" value="1"> 90%, 10%<br>
<input type="radio" name="q6" value="2"> 10%, 10%<br>
<input type="radio" name="q6" value="3"> 90%, Unable to determine<br>
<input type="radio" name="q6" value="4"> 10%, Unable to determine<br>


        </form>
        <button onclick="checkQuiz()">Submit Answer</button>
    </div>

    <!-- 实验内容 -->
    <div class="reward-info">
        <div>
            <div style="width: 20px; height: 20px; background-color: red; border-radius: 50%;"></div>
            <span>=+2$</span>
        </div>
        <div>
            <div style="width: 20px; height: 20px; background-color: blue; border-radius: 50%;"></div>
            <span>=-2$</span>
        </div>
    </div>
    <div class="container">
        <div id="jarA"></div>
        <div id="jarB"></div>
    </div>
    <div class="round" id="roundInfo"></div>
    <div class="slider-container">
        <div class="slider-wrapper">
            <div class="slider-label">willingness points for Jar A</div>
            <input type="range" id="sliderA" class="slider-input" min="0" max="100" value="50" step="1">
            <div class="slider-value" id="sliderAValue">50</div>
        </div>
        <div class="slider-ticks">
            <span>0</span>
            <span>25</span>
            <span>50</span>
            <span>75</span>
            <span>100</span>
        </div>
        <div class="slider-wrapper">
            <div class="slider-label">willingness points for Jar B</div>
            <input type="range" id="sliderB" class="slider-input" min="0" max="100" value="50" step="1">
            <div class="slider-value" id="sliderBValue">50</div>
        </div>
        <div class="slider-ticks">
            <span>0</span>
            <span>25</span>
            <span>50</span>
            <span>75</span>
            <span>100</span>
        </div>
    </div>
    <div class="blank-screen" id="blankScreen"></div>
    <button id="startButton">Begin the Experiment</button>

    <!-- 奖励结果展示 -->
    <div id="rewardResult" class="reward-result" style="display: none;">
        <!-- 第1页：选择轮次 -->
        <div id="rewardPage1">
            <h2>🎉 Ball Draw Result 🎉</h2>
            <div class="phase-container">
                <div class="phase-title">▎Round Draw</div>
                <p>Round <span id="selectedRoundText" class="highlight"></span> has been randomly selected by the system from all allocated trials. </p>
            </div>
            <button onclick="showRewardPage(2)">Continue ▶</button>
        </div>
    
        <!-- 第2页：罐子状态 -->
        <div id="rewardPage2" style="display:none">
            <div class="phase-container">
                <div class="phase-title">▎Jar Draw</div>
                <p>Your willingness points were allocated as follows: JarA  <span id="originalJarAPercent" class="highlight"></span>,JarB  <span id="originalJarBPercent" class="highlight"></span>.</p>
                <p>Based on the allocation ratio of your willingness points, the system randomly selected:</p>
                <div class="comparison-jars">
                    <div class="jar-group">
                        <div id="originalJarA"></div>
                    </div>
                    <div class="jar-group">
                        <div id="originalJarB"></div>
                    </div>
                </div>
            </div>
            <button onclick="showRewardPage(3)">Continue ▶</button>
        </div>
    
        <!-- 第3页：罐子的实际状态 -->
        <div id="rewardPage3" style="display:none">
            <div class="phase-container">
                <div class="phase-title">▎The actual state of <span id="selectedJarExplanation" class="highlight"></span></div>
                <div id="resultJar" style="width: 200px; height: 200px; position: relative;"></div>
            </div>
            <button onclick="showRewardPage(4)">Continue ▶</button>
        </div>
    
        <!-- 第4页：球的抽取 -->
        <div id="rewardPage4" style="display:none">
            <div class="phase-container">
                <div class="phase-title">▎Ball Draw</div>
                <div id="drawBallJar" style="width: 200px; height: 200px; margin: 0 auto; position: relative;"></div>
                <div id="ballAnimation" style="position: absolute; width: 20px; height: 20px; border-radius: 50%; display: none;"></div>
            </div>
            <button onclick="showRewardPage(5)">Continue ▶</button>
        </div>
    
        <!-- 第5页：最终结果 -->
       
<div id="rewardPage5" style="display:none">
    <div class="phase-container">
        <div class="phase-title">▎Reward Result</div>
        <p>The color of the ball randomly drawn from <span id="selectedJarName" class="highlight"></span> by the system is <span id="ballColorExplanation" class="highlight"></span>,
            which means your reward will <span id="rewardExplanation" class="highlight"></span> dollars.</p>
            <p>Your final reward is : <span id="finalReward" class="highlight"></span> dollars.</p>
    </div>
    <button id="closeResult">End the Experiment</button>
</div>

    <script>
        const jarA = document.getElementById('jarA');
        const jarB = document.getElementById('jarB');
        const totalRounds = 93; // 实验总轮次
        let currentRound = 0;
        let isSliderMoved = false;
        const experimentData = [];
        
        const sliderContainer = document.querySelector('.slider-container');
        const sliderA = document.getElementById('sliderA');
        const sliderB = document.getElementById('sliderB');
        const sliderAValue = document.getElementById('sliderAValue');
        const sliderBValue = document.getElementById('sliderBValue');
        const startButton = document.getElementById('startButton');
        const blankScreen = document.getElementById('blankScreen');
 

        sliderA.addEventListener('input', syncSliders);
        sliderB.addEventListener('input', syncSliders);
        startButton.addEventListener('click', startExperiment);

        function syncSliders() {
            const total = parseInt(sliderA.value) + parseInt(sliderB.value);
            if (total !== 100) {
                if (this === sliderA) {
                    sliderB.value = 100 - sliderA.value;
                } else {
                    sliderA.value = 100 - sliderB.value;
                }
            }
            sliderAValue.textContent = sliderA.value;
            sliderBValue.textContent = sliderB.value;
            isSliderMoved = true;
        }
            


        function showBlankScreen() {
            blankScreen.style.display = "flex";
            sliderContainer.style.display = "none";
            startButton.style.display = "none";

            setTimeout(() => {
                if (currentRound < totalRounds) {
                    blankScreen.style.display = "none";
                    sliderContainer.style.display = "block";
                    startButton.style.display = "block";
                    showJars();
                    isSliderMoved = false;
                } else {
                    calculateAndDisplayReward();
                }
            }, 500);
        }

        // 预定义的罐子配置 (替换为你从 Excel 转换的 JavaScript 数组)
        const predefinedConfigurations = [
             { jarA: { red: 1, blue: 0 }, jarB: { red: 2, blue: 0 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 1, blue: 1 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 3, blue: 0 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 2, blue: 1 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 4, blue: 0 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 3, blue: 1 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 2, blue: 2 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 5, blue: 0 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 4, blue: 1 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 3, blue: 2 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 6, blue: 0 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 5, blue: 1 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 4, blue: 2 } },
            { jarA: { red: 1, blue: 0 }, jarB: { red: 3, blue: 3 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 3, blue: 0 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 2, blue: 1 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 3, blue: 0 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 2, blue: 1 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 4, blue: 0 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 3, blue: 1 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 2, blue: 2 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 4, blue: 0 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 3, blue: 1 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 2, blue: 2 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 5, blue: 0 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 4, blue: 1 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 3, blue: 2 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 5, blue: 0 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 4, blue: 1 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 3, blue: 2 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 6, blue: 0 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 5, blue: 1 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 4, blue: 2 } },
            { jarA: { red: 2, blue: 0 }, jarB: { red: 3, blue: 3 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 6, blue: 0 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 5, blue: 1 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 4, blue: 2 } },
            { jarA: { red: 1, blue: 1 }, jarB: { red: 3, blue: 3 } },
            { jarA: { red: 3, blue: 0 }, jarB: { red: 4, blue: 0 } },
            { jarA: { red: 3, blue: 0 }, jarB: { red: 3, blue: 1 } },
            { jarA: { red: 3, blue: 0 }, jarB: { red: 2, blue: 2 } },
            { jarA: { red: 2, blue: 1 }, jarB: { red: 4, blue: 0 } },
            { jarA: { red: 2, blue: 1 }, jarB: { red: 3, blue: 1 } },
            { jarA: { red: 2, blue: 1 }, jarB: { red: 2, blue: 2 } },
            { jarA: { red: 3, blue: 0 }, jarB: { red: 5, blue: 0 } },
            { jarA: { red: 3, blue: 0 }, jarB: { red: 4, blue: 1 } },
            { jarA: { red: 3, blue: 0 }, jarB: { red: 3, blue: 2 } },
            { jarA: { red: 2, blue: 1 }, jarB: { red: 5, blue: 0 } },
            { jarA: { red: 2, blue: 1 }, jarB: { red: 4, blue: 1 } },
            { jarA: { red: 2, blue: 1 }, jarB: { red: 3, blue: 2 } },
            { jarA: { red: 3, blue: 0 }, jarB: { red: 6, blue: 0 } },
            { jarA: { red: 3, blue: 0 }, jarB: { red: 5, blue: 1 } },
            { jarA: { red: 3, blue: 0 }, jarB: { red: 4, blue: 2 } },
            { jarA: { red: 3, blue: 0 }, jarB: { red: 3, blue: 3 } },
            { jarA: { red: 2, blue: 1 }, jarB: { red: 6, blue: 0 } },
            { jarA: { red: 2, blue: 1 }, jarB: { red: 5, blue: 1 } },
            { jarA: { red: 2, blue: 1 }, jarB: { red: 4, blue: 2 } },
            { jarA: { red: 2, blue: 1 }, jarB: { red: 3, blue: 3 } },
            { jarA: { red: 4, blue: 0 }, jarB: { red: 5, blue: 0 } },
            { jarA: { red: 4, blue: 0 }, jarB: { red: 4, blue: 1 } },
            { jarA: { red: 4, blue: 0 }, jarB: { red: 3, blue: 2 } },
            { jarA: { red: 3, blue: 1 }, jarB: { red: 5, blue: 0 } },
            { jarA: { red: 3, blue: 1 }, jarB: { red: 4, blue: 1 } },
            { jarA: { red: 3, blue: 1 }, jarB: { red: 3, blue: 2 } },
            { jarA: { red: 2, blue: 2 }, jarB: { red: 5, blue: 0 } },
            { jarA: { red: 2, blue: 2 }, jarB: { red: 4, blue: 1 } },
            { jarA: { red: 2, blue: 2 }, jarB: { red: 3, blue: 2 } },
            { jarA: { red: 4, blue: 0 }, jarB: { red: 6, blue: 0 } },
            { jarA: { red: 4, blue: 0 }, jarB: { red: 5, blue: 1 } },
            { jarA: { red: 4, blue: 0 }, jarB: { red: 4, blue: 2 } },
            { jarA: { red: 4, blue: 0 }, jarB: { red: 3, blue: 3 } },
            { jarA: { red: 3, blue: 1 }, jarB: { red: 6, blue: 0 } },
            { jarA: { red: 3, blue: 1 }, jarB: { red: 5, blue: 1 } },
            { jarA: { red: 3, blue: 1 }, jarB: { red: 4, blue: 2 } },
            { jarA: { red: 3, blue: 1 }, jarB: { red: 3, blue: 3 } },
            { jarA: { red: 2, blue: 2 }, jarB: { red: 6, blue: 0 } },
            { jarA: { red: 2, blue: 2 }, jarB: { red: 5, blue: 1 } },
            { jarA: { red: 2, blue: 2 }, jarB: { red: 4, blue: 2 } },
            { jarA: { red: 2, blue: 2 }, jarB: { red: 3, blue: 3 } },
            { jarA: { red: 5, blue: 0 }, jarB: { red: 6, blue: 0 } },
            { jarA: { red: 5, blue: 0 }, jarB: { red: 5, blue: 1 } },
            { jarA: { red: 5, blue: 0 }, jarB: { red: 4, blue: 2 } },
            { jarA: { red: 5, blue: 0 }, jarB: { red: 3, blue: 3 } },
            { jarA: { red: 4, blue: 1 }, jarB: { red: 6, blue: 0 } },
            { jarA: { red: 4, blue: 1 }, jarB: { red: 5, blue: 1 } },
            { jarA: { red: 4, blue: 1 }, jarB: { red: 4, blue: 2 } },
            { jarA: { red: 4, blue: 1 }, jarB: { red: 3, blue: 3 } },
            { jarA: { red: 3, blue: 2 }, jarB: { red: 6, blue: 0 } },
            { jarA: { red: 3, blue: 2 }, jarB: { red: 5, blue: 1 } },
            { jarA: { red: 3, blue: 2 }, jarB: { red: 4, blue: 2 } },
            { jarA: { red: 3, blue: 2 }, jarB: { red: 3, blue: 3 } },
           
        ];

        let usedConfigurationIndices = []; // 存储已使用的配置索引

        function getRandomConfigurationIndex() {
            if (usedConfigurationIndices.length === predefinedConfigurations.length) {
                // 如果所有配置都已使用，则重置已使用配置的列表
                usedConfigurationIndices = [];
            }

            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * predefinedConfigurations.length);
            } while (usedConfigurationIndices.includes(randomIndex));

            usedConfigurationIndices.push(randomIndex);
            return randomIndex;
        }

        function showJars() {
    currentRound++;
    let jarAConfig, jarBConfig;

    // 注意力检测试次逻辑
    if (currentRound === Math.floor(totalRounds/3) || 
        currentRound === Math.floor(totalRounds*2/3)) {
        // 第一个检测试次：A全红，B全蓝
        if (currentRound === Math.floor(totalRounds/3)) {
            jarAConfig = { red: 10, blue: 0, type: "attention-check" };
            jarBConfig = { red: 0, blue: 10, type: "attention-check" };
        }
        // 第二个检测试次：A全蓝，B全红
        else {
            jarAConfig = { red: 0, blue: 10, type: "attention-check" };
            jarBConfig = { red: 10, blue: 0, type: "attention-check" };
        }
    } 
    else {
        // 常规试次逻辑
        const randomIndex = getRandomConfigurationIndex();
        const configuration = predefinedConfigurations[randomIndex];
        jarAConfig = { ...configuration.jarA, type: "normal" };
        jarBConfig = { ...configuration.jarB, type: "normal" };
    }

    // 显示罐子
    displayJar(jarA, jarAConfig, "Jar A");
    displayJar(jarB, jarBConfig, "Jar B");

    // 重置滑块
    sliderA.value = 50;
    sliderB.value = 50;
    sliderAValue.textContent = 50;
    sliderBValue.textContent = 50;
}

        

    function displayJar(jarElement, config, jarName) {
    jarElement.innerHTML = ''; // 清空之前的内容
    
    // 添加罐子名称标签
    const jarLabel = document.createElement('div');
    jarLabel.textContent = jarName;
    jarLabel.style.textAlign = 'center';
    jarLabel.style.marginBottom = '10px';
    jarLabel.style.fontWeight = 'bold';
    jarLabel.style.marginTop = '-20px'; 
    jarElement.appendChild(jarLabel);

    const ballContainer = document.createElement('div');
    ballContainer.className = 'ball-container';
    ballContainer.style.display = 'grid';
    ballContainer.style.gridTemplateColumns = 'repeat(5, 1fr)'; // 每行5个
    ballContainer.style.gridTemplateRows = 'repeat(2, 1fr)';    // 共2行
    ballContainer.style.gap = '3px'; // 球之间的间距
    ballContainer.style.width = '80%';
    ballContainer.style.padding = '10px'; // 容器内边距
    ballContainer.style.position = 'relative';
    ballContainer.style.top = '-10px'; // 整体向上移动
    ballContainer.style.left = '10px'; // 整体向右移动

    let balls = [];
    for (let i = 0; i < config.red; i++) {
        balls.push('red');
    }
    for (let i = 0; i < config.blue; i++) {
        balls.push('blue');
    }
    while (balls.length < 10) {
        balls.push('grey'); // 使用'grey'表示未知
    }

    balls.forEach(color => {
        const ball = document.createElement('div');
        ball.className = 'ball ' + color;
        ballContainer.appendChild(ball);
    });

    jarElement.appendChild(ballContainer);
    jarElement.style.position = 'relative';
    jarElement.style.width = '200px';
    jarElement.style.height = '200px';
    jarElement.style.marginLeft = '10px';
    jarElement.style.marginRight = '10px';
    jarElement.style.marginTop = '20px';
    jarElement.style.backgroundImage = "url('罐子.png')";
    jarElement.style.backgroundSize = '100% 100%';
    jarElement.style.backgroundRepeat = 'no-repeat';
}

function recordData() {
    const currentConfig = predefinedConfigurations[usedConfigurationIndices[usedConfigurationIndices.length - 1]];
    // 判断是否为注意力检测轮次
    const isAttentionCheck = currentRound === Math.floor(totalRounds/3) || 
                            currentRound === Math.floor(totalRounds*2/3);

    // 判断注意力检测是否通过
    let isAttentionCheckPassed = false;
    if (isAttentionCheck) {
        const jarAConfig = isAttentionCheck ? (currentRound === Math.floor(totalRounds/3) ? { red: 10, blue: 0 } : { red: 0, blue: 10 }) : currentConfig.jarA;
        const jarBConfig = isAttentionCheck ? (currentRound === Math.floor(totalRounds/3) ? { red: 0, blue: 10 } : { red: 10, blue: 0 }) : currentConfig.jarB;
        
        // 判断滑块值是否符合预期
        if (currentRound === Math.floor(totalRounds/3)) {
            isAttentionCheckPassed = sliderA.value >= 90; // 第一个注意力检测轮次，A罐应为全红
        } else {
            isAttentionCheckPassed = sliderB.value >= 90; // 第二个注意力检测轮次，B罐应为全红
        }
    }

    experimentData.push({
        round: currentRound,
        jarA: {
            red: isAttentionCheck ? (currentRound === Math.floor(totalRounds/3) ? 10 : 0) : currentConfig.jarA.red,
            blue: isAttentionCheck ? (currentRound === Math.floor(totalRounds/3) ? 0 : 10) : currentConfig.jarA.blue
        },
        jarB: {
            red: isAttentionCheck ? (currentRound === Math.floor(totalRounds/3) ? 0 : 10) : currentConfig.jarB.red,
            blue: isAttentionCheck ? (currentRound === Math.floor(totalRounds/3) ? 10 : 0) : currentConfig.jarB.blue
        },
        sliderAValue: parseInt(sliderA.value),
        sliderBValue: parseInt(sliderB.value),
        isAttentionCheck: isAttentionCheck,
        isAttentionCheckPassed: isAttentionCheckPassed // 新增：记录注意力检测是否通过
    });
}


function exportToExcel() {
    // 准备数据
    const wsData = [
        ["轮次", "罐A意愿点", "罐B意愿点", "罐A红球数", "罐A蓝球数", "罐B红球数", "罐B蓝球数", "是否为注意力检测", "注意力检测是否通过"],
        ...experimentData.map(data => [
            data.round,
            data.sliderAValue,
            data.sliderBValue,
            data.jarA.red,
            data.jarA.blue,
            data.jarB.red,
            data.jarB.blue,
            data.isAttentionCheck ? "是" : "否",
            data.isAttentionCheck ? (data.isAttentionCheckPassed ? "通过" : "未通过") : "N/A" // 新增：注意力检测结果
        ])
    ];

    // 创建工作表
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // 创建工作簿
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "实验数据");

    // 导出 Excel 文件
    XLSX.writeFile(wb, "实验数据.xlsx");
}


         // 开始实验
         function startExperiment() {
            document.getElementById('instruction').style.display = 'none';
            // 初始化实验
            if (currentRound === 0) {
                sliderContainer.style.display = "block";
                startButton.textContent = "Confirm Allocation";
                showJars();
                return;
            } else {

                // 添加滑动验证
             if (!isSliderMoved) {
                alert("Please allocate your willingness points!");
                return;
                }

                recordData();
                showBlankScreen();
            }
        }

        function showQuiz() {
            // 隐藏指导语
            document.getElementById('instruction').style.display = 'none';
            // 显示问卷
            document.getElementById('quiz').style.display = 'block';

            // 定位到第一个问题
            const firstQuestion = document.querySelector('input[name="q1"]');
            if (firstQuestion) {
            firstQuestion.focus();
        }
    }

        function checkQuiz() {
            const answers = [
                { name: 'q1', correct: '2' },
                { name: 'q2', correct: '4' },
                { name: 'q3', correct: '1' },
                { name: 'q4', correct: '3' },
                { name: 'q5', correct: '1' },
                { name: 'q6', correct: '3' },
            ];

            let allAnswered = true;
            let correctCount = 0;

            answers.forEach(answer => {
                const selected = document.querySelector(`input[name="${answer.name}"]:checked`);
                if (!selected) {
                    allAnswered = false;
                } else if (selected.value === answer.correct) {
                    correctCount++;
                }
            });

            if (!allAnswered) {
                alert("Please answer all questions!");
                return;
            }

            if (correctCount < answers.length) {
                alert(`There is ${answers.length - correctCount} error in your answer.Please read the instructions again!`);
                document.getElementById('instruction').style.display = 'block'; // 显示指导语容器
                document.getElementById('quiz').style.display = 'none';        // 隐藏问卷容器

                // 清空所有已选择的答案
                const radioButtons = document.querySelectorAll('input[type="radio"]');
                radioButtons.forEach(radio => {
                    radio.checked = false;
                });

                showPage(2); // 返回第一页重新阅读指导语
                return;
            }

            // 如果所有答案正确，显示正确反馈
            alert("Answer correct, the experiment officially begins!");
            document.getElementById('quiz').style.display = 'none'; // 隐藏问卷
            startExperiment(); // 开始实验
        }
        
        function showPage(pageNumber) {
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`page${i}`).style.display = 'none';
            }
            document.getElementById(`page${pageNumber}`).style.display = 'block';
        
        } 

                // 添加页面切换函数
                function showRewardPage(pageNumber) {
    for (let i = 1; i <= 5; i++) {
        document.getElementById(`rewardPage${i}`).style.display = 'none';     
    }
    
    if (pageNumber === 2) {
        showSelectionAnimation();
    }
    // 如果是第4页，显示抽球动画
    if (pageNumber === 4) {
        showDrawBallAnimation();
    }
    // 如果是第5页，确保显示正确的球颜色
    if (pageNumber === 5) {
        const ballColor = window.selectedBallColor || 'blue'; // 默认值
        document.getElementById("ballColorExplanation").textContent = ballColor;
        document.getElementById("rewardExplanation").textContent = 
            ballColor === "red" ? "+2" : "-2";
            const reward = ballColor === "red" ? 7 : 3; // 根据球颜色计算最终报酬
            document.getElementById("finalReward").textContent = reward;
    }
    
    document.getElementById(`rewardPage${pageNumber}`).style.display = 'block';
}
             
            
function showDrawBallAnimation() {
    // 获取第三页的罐子元素
    const resultJar = document.getElementById('resultJar');
    
    // 克隆第三页的罐子到第四页
    const drawBallJar = document.getElementById('drawBallJar');
    drawBallJar.innerHTML = resultJar.innerHTML;

    // 添加背景图片样式
    drawBallJar.style.backgroundImage = "url('罐子.png')";
    drawBallJar.style.backgroundSize = '100% 100%';
    drawBallJar.style.backgroundRepeat = 'no-repeat';
    drawBallJar.style.marginTop = '50px'; // 新增：使罐子整体下移

    // 获取所有球
    const balls = drawBallJar.querySelectorAll('.ball');
    const selectedBallIndex = Math.floor(Math.random() * balls.length);
    const selectedBall = balls[selectedBallIndex];

    // 设置所有球半透明
    balls.forEach(ball => {
        ball.style.opacity = '0.3';
    });

    // 开始闪烁动画
    let currentIndex = 0;
    let passCount = 0; // 记录经过被选中球的次数
    const interval = setInterval(() => {
        // 重置上一个球的透明度
        if (currentIndex > 0) {
            balls[currentIndex - 1].style.opacity = '0.3';
        } else {
            balls[balls.length - 1].style.opacity = '0.3';
        }

        // 设置当前球不透明
        balls[currentIndex].style.opacity = '1';

        // 如果当前球是被选中的球，增加计数
        if (currentIndex === selectedBallIndex) {
            passCount++;
        }

        // 如果第二次经过被选中的球，停止动画
        if (passCount === 2) {
            clearInterval(interval);
            // 设置其他球完全透明
            balls.forEach((ball, index) => {
                if (index !== selectedBallIndex) {
                    ball.style.opacity = '0';
                }
            });
            
            // 获取被选中球的颜色
    selectedBallColor = selectedBall.classList.contains('red') ? 'red' : 'blue';
    
    // 将结果存储在全局变量中
    window.selectedBallColor = selectedBallColor;

    // 更新第五页的球颜色显示
    document.getElementById("ballColorExplanation").textContent = selectedBallColor;
    document.getElementById("rewardExplanation").textContent = 
        selectedBallColor === "red" ? "+2" : "-2";
    const reward = selectedBallColor === "red" ? 7 : 3;
    document.getElementById("finalReward").textContent = reward;

            
            return;
        }

        currentIndex = (currentIndex + 1) % balls.length;
    }, 200);
}


            // 添加选择动画函数
function showSelectionAnimation() {
    const jarA = document.getElementById('originalJarA');
    const jarB = document.getElementById('originalJarB');
    const selectedJarName = document.getElementById('selectedJarName').textContent;

    let opacity = 1;
    let count = 0;
    const maxCount = 10; // 闪烁次数

    const animation = setInterval(() => {
        if (count >= maxCount) {
            clearInterval(animation);
            // 最终状态
            if (selectedJarName === "Jar A") {
                jarA.style.opacity = 1;
                jarB.style.opacity = 0.3;
            } else {
                jarA.style.opacity = 0.3;
                jarB.style.opacity = 1;
            }
            return;
        }

        // 交替变化透明度
        opacity = opacity === 1 ? 0.3 : 1;
        jarA.style.opacity = opacity;
        jarB.style.opacity = opacity === 1 ? 0.3 : 1;
        count++;
    }, 150); // 每100ms变化一次
}


// 修改calculateAndDisplayReward函数
function calculateAndDisplayReward() {
    // 随机选择结算轮次
    const selectedRoundIndex = Math.floor(Math.random() * experimentData.length);
    const selectedRoundData = experimentData[selectedRoundIndex];

    // 获取概率值
    const jarAChance = selectedRoundData.sliderAValue;
    const jarBChance = selectedRoundData.sliderBValue;

    // 随机选择罐子
    let selectedJar, selectedJarName, selectedJarExplanation;
    if (Math.random() * 100 < jarAChance) {
        selectedJar = selectedRoundData.jarA;
        selectedJarName = "Jar A";
        selectedJarExplanation = "Jar A";
    } else {
        selectedJar = selectedRoundData.jarB;
        selectedJarName = "Jar B";
        selectedJarExplanation = "Jar B";
    }

    // 显示结果弹窗
    document.getElementById("rewardResult").style.display = "block";
    showRewardPage(1);
    document.getElementById("selectedRoundText").textContent = selectedRoundData.round;
    document.getElementById("selectedJarName").textContent = selectedJarName;
    document.getElementById("selectedJarExplanation").textContent = selectedJarExplanation;

    // 显示原始罐子状态
    displayJar(document.getElementById("originalJarA"), selectedRoundData.jarA, "Jar A");
    displayJar(document.getElementById("originalJarB"), selectedRoundData.jarB, "Jar B");

    // 调整两个罐子的显示和布局
    const jarContainer = document.querySelector('.comparison-jars');
    jarContainer.style.display = 'flex';
    jarContainer.style.justifyContent = 'center';
    jarContainer.style.gap = '50px'; // 增加两个罐子之间的间距
    jarContainer.style.marginTop = '80px'; // 统一容器位置 

    const ballContainers = document.querySelectorAll('.comparison-jars .ball-container');
    ballContainers.forEach(container => {
        container.style.top = '-30px'; // 球整体向上移动更多
    });
    

    // ==== 关键修改部分：生成实际罐子状态 ====
    // 获取原始罐子的球颜色顺序
    const originalJarElement = selectedJarName === "Jar A" ? 
        document.getElementById("originalJarA") : 
        document.getElementById("originalJarB");
    const originalBalls = Array.from(originalJarElement.querySelectorAll('.ball'));

    // 创建实际罐子配置
    const actualJar = {
        red: selectedJar.red,
        blue: selectedJar.blue
    };

    // 生成新球数组（保留原始红蓝位置，替换灰色球）
    const newBalls = [];
    originalBalls.forEach(ball => {
        if (ball.classList.contains('red')) {
            newBalls.push('red');
        } else if (ball.classList.contains('blue')) {
            newBalls.push('blue');
        } else {
            // 随机替换灰色球
            if (Math.random() < 0.5) {
                newBalls.push('red');
                actualJar.red++;
            } else {
                newBalls.push('blue');
                actualJar.blue++;
            }
        }
    });

    // 显示实际罐子
    const resultJarElement = document.getElementById("resultJar");
    displayJar(resultJarElement, actualJar, selectedJarName);
    
    // 手动替换球元素以保持顺序
    const ballContainer = resultJarElement.querySelector('.ball-container');
    ballContainer.innerHTML = ''; // 清空自动生成的球
    newBalls.forEach(color => {
        const ball = document.createElement('div');
        ball.className = `ball ${color}`;
        ballContainer.appendChild(ball);
    });

    // 调整样式
    resultJarElement.style.margin = "0 auto";
    resultJarElement.style.float = "none";
    resultJarElement.style.width = "200px";
    resultJarElement.style.height = "200px";
    resultJarElement.style.backgroundImage = "url('罐子.png')";
    resultJarElement.style.backgroundSize = '100% 100%';
    resultJarElement.style.marginTop = '50px'; // 新增：使罐子整体下移
    ballContainer.style.top = '-30px';
    ballContainer.style.left = '10px';

    // 显示意愿点比例
    document.getElementById("originalJarAPercent").textContent = jarAChance;
    document.getElementById("originalJarBPercent").textContent = jarBChance;

    // 关闭结果弹窗
    document.getElementById("closeResult").addEventListener("click", function() {
        document.getElementById("rewardResult").style.display = "none";
        showEndScreen();
    });
}

        // 显示实验结束界面
        function showEndScreen() {
            blankScreen.textContent = "Thank you for being part of this study! You can press the spacebar to exit now, or the system will close in 10 seconds.";
            blankScreen.style.display = "flex";
            exportToExcel();

            // 监听空格键按下事件
            document.addEventListener("keydown", function(event) {
                if (event.code === "Space") {
                    window.close();
                }
            });

            // 10秒后自动退出
            setTimeout(() => {
                window.close();
            }, 10000);
        }
    </script>
</body>
</html>
